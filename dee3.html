<html>
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <title>DuoMoji</title>
    <style media="screen">
      body{
        background-image: url(static/bg.png);
      }
    </style>
  </head>
<body>

</body>



<script type="text/javascript">


var svgContainer = d3.select("body").append("svg")
                                      .attr("width", 1000)
                                      .attr("height", 1000);


var defs = svgContainer.append("defs");
var imgLen=(Array(100))
defs.selectAll(null)
    .data(imgLen)
    .enter()
    .append("pattern")
    .attr("id", function(d,i) {
        return "img-"+('00'+i).slice(-2)
    })
    .attr("height", "100%")
    .attr("width", "100%")
    .attr("patternContentUnits", "objectBoundingBox")
    .append("image")
    .attr('x',0.15)
    .attr('y',0.15)
    .attr("height", 0.7)
    .attr("width", 0.7)
    .attr("preserveAspectRatio", "none")
    .attr("xlink:href", function(d,i) {
        return "static/data/"+((i+1)+'.png')
    });




function drawPoint(center,r=10,_id="rand",fill='#FF8A65'){
                    var circle = svgContainer.append("circle")
                                              //.attr("stroke", "#FF8A65")
                                              .attr("fill", fill)
                                              .attr('id',_id)
                                              .attr("cx", center[0])
                                              .attr("cy", center[1])
                                              .attr("r" , r);
                    return circle;
}

function drawCurve(points,_id='rand',clr="#CFD8DC",anim=false){
                    var curveFunc = d3.line()
                        .x(function(d) {return d[0]})
                        .y(function(d) {return d[1]})
                        .curve(d3.curveBasis);

                    var curve = svgContainer.append("path")
                                            .attr('id',_id)
                                            .attr("d", curveFunc(points))
                                            .attr("stroke", clr)
                                            .attr("stroke-opacity", 0.2)
                                            .attr("stroke-width", 7)
                                            .attr("fill", "none");

                    if(anim){
                        var totalLength = curve.node().getTotalLength();
                        curve
                            .attr("stroke-dasharray", totalLength + " " + totalLength)
                            .attr("stroke-dashoffset", totalLength)
                            .transition()
                              .duration(1000)
                              .ease(d3.easeSin)
                              .attr("stroke-dashoffset", totalLength*3)
                    }
}


function plotNodes(center,radius,numNode){
                    var theta = 2*Math.PI/numNode;
                    var nodes=[]
                    for(var i=0;i<numNode;i++){
                        var x=center[0]+Math.sin(theta*i)*radius
                        var y=center[1]-Math.cos(theta*i)*radius
                        drawPoint([x,y],r=40,_id='node-'+i,fill='url(#img-'+nodeList[i]+')')
                        nodes.push([x,y])
                    }
                    return nodes;

}

function findBend(center,numNode,ind1,ind2,sRadius){
                    var theta = 2*Math.PI/numNode;
                    var cx=center[0]+Math.sin(theta*ind1)*sRadius;
                    var cy=center[1]-Math.cos(theta*ind1)*sRadius;
                    var x=cx+Math.sin(theta*ind2)*sRadius
                    var y=cy-Math.cos(theta*ind2)*sRadius
                    return [x,y]
}


function drawLink(center,radius,nodes,ind1,ind2,clr="#CFD8DC",anim=false){
                  var bend=findBend(center,nodes.length,ind1,ind2,radius/4)
                  drawCurve([nodes[ind1],bend,nodes[ind2]],'link-'+ind1+'-'+ind2,clr,anim)
}

function addEventHandlers(){



    d3.selectAll("path")
        .on("mouseover",function(){
          d3.select(this).transition().style('stroke','#FF7043')
                          .style('stroke-width','5')
          ind=d3.select(this).attr('id').split('-');
          this.parentNode.appendChild(this);
          d3.selectAll('circle').each(function(){this.parentNode.appendChild(this)})
          d3.select('#node-'+ind[1]).transition().style('fill','#c62828')
          d3.select('#node-'+ind[2]).transition().style('fill','#7CB342')

          })

    d3.selectAll("path")
        .on("mouseout",function(){
          d3.select(this).transition().style('stroke','#CFD8DC')
                          .style('stroke-width','2')
          ind=d3.select(this).attr('id').split('-');
          d3.select('#node-'+ind[1]).transition().style('fill','#FF8A65')
          d3.select('#node-'+ind[2]).transition().style('fill','#FF8A65')

        })


    d3.selectAll("circle")
        .on("mouseover",function(){
          d3.select(this).transition().style('fill','#c62828')

          ind=d3.select(this).attr('id').split('-')[1];
          for(i=0;i<21;i++)
          if(i!=ind){
                  var link=d3.select('#link-'+ind+'-'+i)
                  link.transition().style('stroke','#FF7043');
                  link.select(function(){this.parentNode.appendChild(this)});
                  d3.selectAll('circle').each(function(){this.parentNode.appendChild(this)})
          }

          })

    d3.selectAll("circle")
        .on("mouseout",function(){
          d3.select(this).transition().style('fill','#FF8A65')

          ind=d3.select(this).attr('id').split('-')[1];
          for(i=0;i<21;i++)
          if(i!=ind){
                var link=d3.select('#link-'+ind+'-'+i)
                link.transition().style('stroke','#CFD8DC');
                link.select(function(){this.parentNode.appendChild(this)});
                d3.selectAll('circle').each(function(){this.parentNode.appendChild(this)})
          }

        })
}



nodeList=['27', '86', '08', '01', '60', '31', '32',
           '14', '03', '24', '53', '11', '62', '05',
           '38', '48', '19', '28', '71', '10', '90',
           '00', '35', '12', '09']

nodeData=['0500', '0005', '1238', '0301', '0060', '0501',
          '0001', '5327', '0532', '0024', '1900', '0524',
          '0528', '1101', '2753', '0300', '4886', '0335',
          '0508', '0309', '3135', '7127', '3562', '0308',
          '0103', '1005', '0019', '0503', '0028', '0008',
          '6000', '0003', '6235', '9008', '1400']





nodes=plotNodes([500,430],300,nodeList.length)
for(var i=0;i<nodeData.length;i++){
  a=nodeList.indexOf(nodeData[i].slice(0,2))
  b=nodeList.indexOf(nodeData[i].slice(2,4))
  drawLink([500,430],300,nodes,a,b,clr="#CFD8DC");
  d3.selectAll('circle').each(function(){this.parentNode.appendChild(this)})
}


</script>



<script>

setTimeout(function(){

  var source = new EventSource("{{ url_for('sse.stream') }}");
  source.addEventListener('greeting', function(event) {
      var data = JSON.parse(event.data);
      var combData=data.message
      for(var i=0;i<combData.length;i++){
        a=nodeList.indexOf(combData[i].slice(0,2))
        b=nodeList.indexOf(combData[i].slice(2,4))
        drawLink([500,430],300,nodes,a,b,clr="#FF5722",anim=true);
        d3.selectAll('circle').each(function(){this.parentNode.appendChild(this)})
      }

  }, false);

  source.addEventListener('error', function(event) {
      console.log('connection failed')
  }, false);

},1000)




</script>




</html>
